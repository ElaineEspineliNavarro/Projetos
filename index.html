<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<title>Sistema de Agendamento de Visitas a Campo</title>
<style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #4a90e2 0%, #1a3a5e 100%);
        min-height: 100vh;
        padding: 20px;
    }

    .container {
        max-width: 1000px;
        margin: 0 auto;
        background: white;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        overflow: hidden;
    }

    .header {
        background: linear-gradient(135deg, #4a90e2 0%, #1a3a5e 100%);
        color: white;
        padding: 30px;
        text-align: center;
        position: relative;
    }

    .logo-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin-bottom: 20px;
    }

    .logo-img {
        max-width: 200px;
        max-height: 120px;
        margin-bottom: 10px;
        object-fit: contain;
    }

    .tagline {
        font-size: 0.85rem;
        font-weight: 600;
        letter-spacing: 1px;
        opacity: 0.95;
        margin-top: 5px;
    }

    .header h1 {
        font-size: 2rem;
        margin-bottom: 10px;
    }

    .header p {
        opacity: 0.9;
        font-size: 1rem;
    }

    .form-section {
        padding: 15px 30px;
        background: #f8f9fa;
        border-bottom: 2px solid #e9ecef;
        max-height: 50vh;
        overflow-y: auto;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 10px;
        margin-bottom: 10px;
    }

    .form-row.full-width {
        grid-template-columns: 1fr;
    }

    .form-group {
        margin-bottom: 10px;
    }

    .form-group label {
        display: block;
        margin-bottom: 4px;
        font-weight: 600;
        color: #333;
        font-size: 0.75rem;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
        width: 100%;
        padding: 6px 8px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 0.8rem;
        font-family: inherit;
        transition: border-color 0.3s;
        background: white;
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
        outline: none;
        border-color: #4a90e2;
    }

    .form-group select {
        cursor: pointer;
    }

    .form-group select:disabled {
        background: #f5f5f5;
        cursor: not-allowed;
        opacity: 0.6;
    }

    .form-group textarea {
        resize: vertical;
        min-height: 50px;
    }

    .btn {
        padding: 8px 20px;
        border: none;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-top: 5px;
    }

    .btn-primary {
        background: linear-gradient(135deg, #4a90e2 0%, #1a3a5e 100%);
        color: white;
    }

    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(74, 144, 226, 0.4);
    }

    .btn-primary:active {
        transform: translateY(0);
    }

    .list-section {
        padding: 30px;
    }

    .list-section h2 {
        margin-bottom: 20px;
        color: #333;
        font-size: 1.5rem;
    }

    .events-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .events-table thead {
        background: linear-gradient(135deg, #4a90e2 0%, #1a3a5e 100%);
        color: white;
    }

    .events-table th {
        padding: 12px 8px;
        text-align: left;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .events-table td {
        padding: 10px 8px;
        border-bottom: 1px solid #e0e0e0;
        font-size: 0.8rem;
        vertical-align: middle;
    }

    .events-table tbody tr {
        transition: background-color 0.2s;
    }

    .events-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .events-table tbody tr:last-child td {
        border-bottom: none;
    }

    .table-actions {
        display: flex;
        gap: 5px;
        align-items: center;
        justify-content: flex-start;
    }

    .table-input {
        width: 100%;
        padding: 4px 6px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        font-size: 0.8rem;
        font-family: inherit;
    }

    .table-input:focus {
        outline: none;
        border-color: #4a90e2;
    }

    .table-textarea {
        width: 100%;
        padding: 4px 6px;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        font-size: 0.8rem;
        font-family: inherit;
        resize: vertical;
        min-height: 40px;
    }

    .table-textarea:focus {
        outline: none;
        border-color: #4a90e2;
    }

    .events-list {
        overflow-x: auto;
    }

    .event-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .event-card:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .event-fields {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .event-fields > .event-field-readonly {
        display: flex;
        flex-direction: column;
    }

    .event-field {
        display: flex;
        flex-direction: column;
    }

    .event-field.full-width {
        grid-column: 1 / -1;
    }

    .event-field label {
        font-size: 0.85rem;
        font-weight: 600;
        color: #555;
        margin-bottom: 5px;
    }

    .event-field input,
    .event-field textarea {
        padding: 10px;
        border: 2px solid #e0e0e0;
        border-radius: 6px;
        font-size: 0.95rem;
        font-family: inherit;
        transition: border-color 0.3s;
        width: 100%;
    }

    .event-field input:focus,
    .event-field textarea:focus {
        outline: none;
        border-color: #4a90e2;
    }

    .event-field textarea {
        resize: vertical;
        min-height: 80px;
    }

    .event-field-readonly {
        display: flex;
        flex-direction: column;
    }

    .event-field-readonly.full-width {
        grid-column: 1 / -1;
    }

    .event-field-readonly label {
        font-size: 0.85rem;
        font-weight: 600;
        color: #555;
        margin-bottom: 5px;
    }

    .event-field-readonly .field-value {
        padding: 10px;
        background: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        font-size: 0.95rem;
        color: #333;
        min-height: 40px;
        display: flex;
        align-items: center;
        white-space: pre-wrap;
    }

    .event-field-readonly .field-value.empty {
        color: #999;
        font-style: italic;
    }

    .btn-edit {
        background: #4a90e2;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 8px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-edit:hover {
        background: #357abd;
        transform: scale(1.05);
    }

    .btn-save {
        background: #28a745;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 8px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-save:hover {
        background: #218838;
        transform: scale(1.05);
    }

    .btn-cancel {
        background: #6c757d;
        color: white;
        padding: 8px 15px;
        border: none;
        border-radius: 8px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-cancel:hover {
        background: #5a6268;
        transform: scale(1.05);
    }

    .events-table tbody tr.editing-row {
        background-color: #e3f2fd;
    }

    .event-info {
        flex: 1;
    }

    .event-date {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 8px;
    }

    .event-description {
        color: #666;
        font-size: 0.95rem;
        margin-bottom: 10px;
    }

    .event-status {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 15px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-aguardando {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffc107;
    }

    .status-concluido {
        background: #d4edda;
        color: #155724;
        border: 1px solid #28a745;
    }

    .status-cancelado {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #dc3545;
    }

    .event-actions {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .status-select {
        padding: 8px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 0.9rem;
        font-family: inherit;
        cursor: pointer;
        background: white;
        transition: border-color 0.3s;
    }

    .status-select:focus {
        outline: none;
        border-color: #4a90e2;
    }

        .btn-delete {
            background: #dc3545;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-delete:hover {
            background: #c82333;
            transform: scale(1.05);
        }

        .btn-link {
            background: #17a2b8;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-link:hover {
            background: #138496;
            transform: scale(1.05);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state p {
            font-size: 1.1rem;
        }

        .logo-fiex {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            font-size: 3.5rem;
            font-weight: bold;
            font-family: 'Brush Script MT', cursive, sans-serif;
        }

        .logo-f {
            color: #ff0000;
            font-size: 4rem;
        }

        .logo-iex {
            color: white;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }

            .logo-img {
                max-width: 150px;
                max-height: 80px;
            }

            .logo-fiex {
                font-size: 2.5rem;
            }

            .logo-f {
                font-size: 3rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .events-table {
                font-size: 0.7rem;
            }

            .events-table th,
            .events-table td {
                padding: 8px 4px;
                font-size: 0.7rem;
            }

            .table-actions {
                flex-wrap: wrap;
                gap: 3px;
            }

            .events-table {
                display: block;
                overflow-x: auto;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo-container">
                <img src="logo-fiex.png" alt="FIEX Logo" class="logo-img" 
                     onerror="this.style.display='none'; const fallback = this.nextElementSibling; if(fallback) fallback.style.display='flex';">
                <div class="logo-fiex" style="display: none;">
                    <span class="logo-f">F</span><span class="logo-iex">iex</span>
                </div>
                <div class="tagline">FRIBOI ‚Ä¢ INOVA√á√ÉO E EXCEL√äNCIA</div>
            </div>
            <h1>üìÖ Sistema de Agendamento de Visitas a Campo</h1>
            <p>Marque suas visitas e classifique como concluido ou cancelado para gest√£o das visitas</p>
        </div>

        <div class="form-section">
            <form id="agendamentoForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="dataVisita">Data da Visita:</label>
                        <input type="date" id="dataVisita" name="dataVisita" required>
                    </div>
                    <div class="form-group">
                        <label for="nome">Nome:</label>
                        <input 
                            type="text" 
                            id="nome" 
                            name="nome" 
                            placeholder="Digite o nome..."
                        >
                    </div>
                    <div class="form-group">
                        <label for="unidade">Unidade: <span style="color: red;">*</span></label>
                        <select id="unidade" name="unidade" required>
                            <option value="">Selecione a unidade...</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="vendedor">Vendedor da Rota: <span style="color: red;">*</span></label>
                        <select id="vendedor" name="vendedor" required disabled>
                            <option value="">Primeiro selecione a unidade</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="perfilVendedor">Perfil do Vendedor:</label>
                        <input 
                            type="text" 
                            id="perfilVendedor" 
                            name="perfilVendedor" 
                            placeholder="Ser√° preenchido automaticamente"
                            readonly
                            style="background: #f5f5f5;"
                        >
                    </div>
                    <div class="form-group">
                        <label for="comentarios">Coment√°rios:</label>
                        <textarea 
                            id="comentarios" 
                            name="comentarios" 
                            placeholder="Digite os coment√°rios..."
                        ></textarea>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary">
                    ‚ûï Adicionar Agendamento
                </button>
            </form>
        </div>

        <div class="list-section">
            <h2>üìã Lista de Agendamentos</h2>
            <div id="eventsList" class="events-list">
                <!-- Os eventos ser√£o renderizados aqui dinamicamente -->
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURA√á√ÉO DO FIREBASE
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyD5ezsxITVbDTlsWWjlJH4ZhGkvQ5xeNjI",
            authDomain: "agenda-de-visitas-7679e.firebaseapp.com",
            databaseURL: "https://agenda-de-visitas-7679e-default-rtdb.firebaseio.com",
            projectId: "agenda-de-visitas-7679e",
            storageBucket: "agenda-de-visitas-7679e.firebasestorage.app",
            messagingSenderId: "83784197994",
            appId: "1:83784197994:web:41baa29763fc1ac3bb6713"
        };

        // Inicializar Firebase
        let database;
        
        // Verificar se Firebase est√° carregado
        if (typeof firebase === 'undefined') {
            console.error('Firebase n√£o foi carregado! Verifique a conex√£o com a internet.');
            alert('Erro: Firebase n√£o foi carregado. Verifique sua conex√£o com a internet.');
        } else {
            try {
                firebase.initializeApp(firebaseConfig);
                database = firebase.database();
                console.log('Firebase inicializado com sucesso!');
            } catch (error) {
                console.error('Erro ao inicializar Firebase:', error);
                console.error('Detalhes do erro:', error.message, error.code);
                alert('Erro ao conectar com o banco de dados: ' + error.message);
            }
        }

        // ============================================
        // DADOS DAS LISTAS SUSPENSAS
        // ============================================
        let dadosListaSuspensa = {
            unidades: [],
            vendedores: []
        };

        // Dados do JSON embutidos como fallback (caso o arquivo n√£o carregue)
        const dadosListaSuspensaEmbedded = {
            "unidades": [
                {"id": "unidade1", "nome": "BAU"},
                {"id": "unidade2", "nome": "BTM"},
                {"id": "unidade3", "nome": "CNT"},
                {"id": "unidade4", "nome": "CRT"},
                {"id": "unidade5", "nome": "DCA"},
                {"id": "unidade6", "nome": "DIT"},
                {"id": "unidade7", "nome": "DMG"},
                {"id": "unidade8", "nome": "DPR"},
                {"id": "unidade9", "nome": "DSP"},
                {"id": "unidade10", "nome": "GYN"},
                {"id": "unidade11", "nome": "REC"},
                {"id": "unidade12", "nome": "RJN"},
                {"id": "unidade13", "nome": "SFL"},
                {"id": "unidade14", "nome": "CPG"},
                {"id": "unidade15", "nome": "MRA"},
                {"id": "unidade16", "nome": "PVH"},
                {"id": "unidade17", "nome": "PVH"}
            ],
            "vendedores": [
                {"id": "vendedor1", "nome": "JESSICA PUGGINA DA SILVA", "unidadeId": "unidade1", "perfil": "FOOD"},
                {"id": "vendedor2", "nome": "VAGNER ANNIBAL SANTANA MATTOS", "unidadeId": "unidade1", "perfil": "MISTO"},
                {"id": "vendedor3", "nome": "BRUNO GUILHERME DE TILIO", "unidadeId": "unidade1", "perfil": "MISTO"},
                {"id": "vendedor4", "nome": "ANDRE LUIS SANTINHO", "unidadeId": "unidade2", "perfil": "FOOD"},
                {"id": "vendedor5", "nome": "JOEL PEREIRA DE OLIVEIRA JUNIOR", "unidadeId": "unidade2", "perfil": "MISTO"},
                {"id": "vendedor6", "nome": "LUIS FERNANDO MINELLI", "unidadeId": "unidade2", "perfil": "MISTO"},
                {"id": "vendedor7", "nome": "CATIA FERNANDA DOS SANTOS COSTA", "unidadeId": "unidade3", "perfil": "FOOD"},
                {"id": "vendedor8", "nome": "FLAVIO JUNIO SANTANA", "unidadeId": "unidade3", "perfil": "MISTO"},
                {"id": "vendedor9", "nome": "GIZELE MEDEIROS DE OLIVEIRA BATISTA", "unidadeId": "unidade3", "perfil": "MISTO"},
                {"id": "vendedor10", "nome": "MICHEL PLATINI DE OLIVEIRA", "unidadeId": "unidade4", "perfil": "FOOD"},
                {"id": "vendedor11", "nome": "ROBERTH DOS SANTOS CASAGRANDE", "unidadeId": "unidade4", "perfil": "MISTO"},
                {"id": "vendedor12", "nome": "ANDREZA FATIMA DOS SANTOS DE CASSIANO", "unidadeId": "unidade4", "perfil": "MISTO"},
                {"id": "vendedor13", "nome": "AILTON PEREIRA DE SOUSA", "unidadeId": "unidade5", "perfil": "FOOD"},
                {"id": "vendedor14", "nome": "ANDRE LUIS DA SILVA CHINI", "unidadeId": "unidade5", "perfil": "MISTO"},
                {"id": "vendedor15", "nome": "DENIS SETRA DE OLIVEIRA", "unidadeId": "unidade5", "perfil": "MISTO"},
                {"id": "vendedor16", "nome": "RAFAEL NUNES DOS SANTOS", "unidadeId": "unidade6", "perfil": "FOOD"},
                {"id": "vendedor17", "nome": "GABRIEL DORNELLES RIHL", "unidadeId": "unidade6", "perfil": "MISTO"},
                {"id": "vendedor18", "nome": "BRAULIO DILLY", "unidadeId": "unidade6", "perfil": "MISTO"},
                {"id": "vendedor19", "nome": "JOSENILTON ALVES DA SILVA", "unidadeId": "unidade7", "perfil": "MISTO"},
                {"id": "vendedor20", "nome": "PABLO ALVES DE MELO OLIVEIRA", "unidadeId": "unidade7", "perfil": "MISTO"},
                {"id": "vendedor21", "nome": "JOAO BATISTA ALVARENGA ROSA", "unidadeId": "unidade7", "perfil": "MISTO"},
                {"id": "vendedor22", "nome": "SERGIO DE ANDRADE SOARES", "unidadeId": "unidade8", "perfil": "MISTO"},
                {"id": "vendedor23", "nome": "OZIEL GONCALVES DOS SANTOS", "unidadeId": "unidade8", "perfil": "MISTO"},
                {"id": "vendedor24", "nome": "EVELYN DAVATZ DE OLIVEIRA LIMA DA SILVA", "unidadeId": "unidade8", "perfil": "MISTO"},
                {"id": "vendedor25", "nome": "ANDRESSA GOBO SOUZA", "unidadeId": "unidade9", "perfil": "FOOD"},
                {"id": "vendedor26", "nome": "CELDINEI ARAUJO DA SILVA", "unidadeId": "unidade9", "perfil": "MISTO"},
                {"id": "vendedor27", "nome": "RODOLPHO CHIESI DA SILVA", "unidadeId": "unidade9", "perfil": "MISTO"},
                {"id": "vendedor28", "nome": "DIEGO ALVES ROCHA", "unidadeId": "unidade10", "perfil": "FOOD"},
                {"id": "vendedor29", "nome": "IVANILDO CONCEICAO ROCHA", "unidadeId": "unidade10", "perfil": "VAREJO DE PLANTA"},
                {"id": "vendedor30", "nome": "WARLEY DE OLIVEIRA DUTRA", "unidadeId": "unidade10", "perfil": "VAREJO DE PLANTA"},
                {"id": "vendedor31", "nome": "YVISON KAUAN DA SILVA", "unidadeId": "unidade11", "perfil": "FOOD"},
                {"id": "vendedor32", "nome": "MARIA EDLANE LOPES DOS SANTOS", "unidadeId": "unidade11", "perfil": "MISTO"},
                {"id": "vendedor33", "nome": "EDILSON VICENTE BATISTA", "unidadeId": "unidade11", "perfil": "MISTO"},
                {"id": "vendedor34", "nome": "ANTONIO CARLOS MACIEL DA COSTA JUNIOR", "unidadeId": "unidade12", "perfil": "FOOD"},
                {"id": "vendedor35", "nome": "SABRINA DA SILVA ROSENDO DE AGUIAR", "unidadeId": "unidade12", "perfil": "MISTO"},
                {"id": "vendedor36", "nome": "LEONARDO PEREIRA DE SOUZA", "unidadeId": "unidade12", "perfil": "MISTO"},
                {"id": "vendedor37", "nome": "GABRIEL REBOUCAS ESMERA DOS SANTOS", "unidadeId": "unidade13", "perfil": "FOOD"},
                {"id": "vendedor38", "nome": "RICARDO MAGALHAES DE CARVALHO", "unidadeId": "unidade13", "perfil": "MISTO"},
                {"id": "vendedor39", "nome": "JADIVAL ALMEIDA DA SILVA", "unidadeId": "unidade13", "perfil": "MISTO"},
                {"id": "vendedor40", "nome": "GETULIO DE OLIVEIRA JUNIOR", "unidadeId": "unidade14", "perfil": "FOOD"},
                {"id": "vendedor41", "nome": "GUILHERME FERREIRA TARGINO", "unidadeId": "unidade14", "perfil": "MISTO"},
                {"id": "vendedor42", "nome": "DJAIR JUNIOR NASCIMENTO LOPES ROLIN", "unidadeId": "unidade14", "perfil": "MISTO"},
                {"id": "vendedor43", "nome": "FRANCISCO CRISANLEUSON BEZERRA DA SILVA", "unidadeId": "unidade15", "perfil": "FOOD"},
                {"id": "vendedor44", "nome": "JOAO FRANCISCO PEREIRA COSTA", "unidadeId": "unidade15", "perfil": "MISTO"},
                {"id": "vendedor45", "nome": "PAULO HENRIQUE DO NASCIMENTO SILVA", "unidadeId": "unidade15", "perfil": "MISTO"},
                {"id": "vendedor46", "nome": "MARIO BETUCCI NETO", "unidadeId": "unidade16", "perfil": "FOOD"},
                {"id": "vendedor47", "nome": "KELITON VIANA GARCIA", "unidadeId": "unidade16", "perfil": "VAREJO DE PLANTA"},
                {"id": "vendedor48", "nome": "CRISTIANO ALVES DE BARROS", "unidadeId": "unidade16", "perfil": "VAREJO DE PLANTA"}
            ]
        };

        // Carregar dados do JSON
        async function carregarDadosListaSuspensa() {
            // PRIMEIRO: Sempre usar dados embutidos para garantir funcionamento
            dadosListaSuspensa = JSON.parse(JSON.stringify(dadosListaSuspensaEmbedded));
            console.log('‚úÖ Dados embutidos carregados (garantindo funcionamento)');
            console.log(`üìä ${dadosListaSuspensa.unidades.length} unidades dispon√≠veis`);
            console.log(`üë• ${dadosListaSuspensa.vendedores.length} vendedores dispon√≠veis`);
            console.log('üìã Primeira unidade:', dadosListaSuspensa.unidades[0]?.nome);
            console.log('üë§ Primeiro vendedor:', dadosListaSuspensa.vendedores[0]?.nome);
            
            // Inicializar dropdowns imediatamente com dados embutidos
            inicializarDropdowns();
            
            // DEPOIS: Tentar atualizar do arquivo (opcional, n√£o bloqueia)
            try {
                console.log('üîÑ Tentando atualizar com dados-lista-suspensa.json...');
                const response = await fetch('dados-lista-suspensa.json', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    cache: 'no-cache'
                });
                
                if (!response.ok) {
                    throw new Error(`Erro HTTP: ${response.status} - ${response.statusText}`);
                }
                
                const dados = await response.json();
                
                // Validar estrutura dos dados
                if (!dados.unidades || !Array.isArray(dados.unidades)) {
                    throw new Error('Estrutura de dados inv√°lida: campo "unidades" n√£o encontrado');
                }
                if (!dados.vendedores || !Array.isArray(dados.vendedores)) {
                    throw new Error('Estrutura de dados inv√°lida: campo "vendedores" n√£o encontrado');
                }
                
                // Atualizar com dados do arquivo
                dadosListaSuspensa = dados;
                console.log('‚úÖ Dados atualizados do arquivo JSON!');
                console.log(`üìä ${dadosListaSuspensa.unidades.length} unidades no arquivo`);
                console.log(`üë• ${dadosListaSuspensa.vendedores.length} vendedores no arquivo`);
                
                // Reinicializar dropdowns com dados atualizados
                inicializarDropdowns();
            } catch (error) {
                console.warn('‚ö†Ô∏è N√£o foi poss√≠vel carregar dados-lista-suspensa.json');
                console.warn('üìù Continuando com dados embutidos (j√° carregados)');
                console.warn('üí° Dica: Para usar o arquivo JSON, abra via servidor local');
            }
        }

        // Fun√ß√µes para gerenciar dropdowns
        let handlerUnidade = null;
        let handlerVendedor = null;

        // Inicializar dropdowns
        function inicializarDropdowns() {
            const selectUnidade = document.getElementById('unidade');
            const selectVendedor = document.getElementById('vendedor');
            
            if (!selectUnidade || !selectVendedor) {
                console.error('Elementos do formul√°rio n√£o encontrados!');
                return;
            }
            
            // Verificar se os dados foram carregados
            if (!dadosListaSuspensa || !dadosListaSuspensa.unidades || dadosListaSuspensa.unidades.length === 0) {
                console.error('Dados das listas suspensas n√£o foram carregados!');
                return;
            }
            
            // Limpar op√ß√µes existentes
            selectUnidade.innerHTML = '<option value="">Selecione a unidade...</option>';
            selectVendedor.innerHTML = '<option value="">Primeiro selecione a unidade</option>';
            selectVendedor.disabled = true;
            
            // Preencher dropdown de unidades com dados do JSON
            dadosListaSuspensa.unidades.forEach(unidade => {
                const option = document.createElement('option');
                option.value = unidade.id;
                option.textContent = unidade.nome;
                selectUnidade.appendChild(option);
            });

            console.log(`‚úÖ Dropdown de unidades preenchido com ${dadosListaSuspensa.unidades.length} unidades`);

            // Remover listeners antigos se existirem
            if (handlerUnidade) {
                selectUnidade.removeEventListener('change', handlerUnidade);
            }
            if (handlerVendedor) {
                selectVendedor.removeEventListener('change', handlerVendedor);
            }

            // Event listener para mudan√ßa de unidade
            handlerUnidade = function() {
                const unidadeId = this.value;
                const selectVendedor = document.getElementById('vendedor');
                const inputPerfil = document.getElementById('perfilVendedor');
                
                // Limpar vendedor e perfil
                selectVendedor.innerHTML = '<option value="">Selecione o vendedor...</option>';
                selectVendedor.disabled = !unidadeId;
                if (inputPerfil) inputPerfil.value = '';
                
                if (unidadeId) {
                    // Filtrar vendedores da unidade selecionada usando dados do JSON
                    const vendedoresFiltrados = dadosListaSuspensa.vendedores.filter(
                        v => v.unidadeId === unidadeId
                    );
                    
                    console.log(`üìã Vendedores encontrados para unidade ${unidadeId}: ${vendedoresFiltrados.length}`);
                    
                    if (vendedoresFiltrados.length === 0) {
                        selectVendedor.innerHTML = '<option value="">Nenhum vendedor encontrado para esta unidade</option>';
                        selectVendedor.disabled = true;
                    } else {
                        vendedoresFiltrados.forEach(vendedor => {
                            const option = document.createElement('option');
                            option.value = vendedor.id;
                            option.textContent = vendedor.nome;
                            option.dataset.perfil = vendedor.perfil || '';
                            selectVendedor.appendChild(option);
                        });
                        selectVendedor.disabled = false;
                    }
                }
            };

            // Event listener para mudan√ßa de vendedor
            handlerVendedor = function() {
                const selectedOption = this.options[this.selectedIndex];
                const inputPerfil = document.getElementById('perfilVendedor');
                
                if (selectedOption && selectedOption.dataset.perfil && inputPerfil) {
                    inputPerfil.value = selectedOption.dataset.perfil;
                    console.log(`‚úÖ Perfil preenchido automaticamente: ${selectedOption.dataset.perfil}`);
                } else if (inputPerfil) {
                    inputPerfil.value = '';
                }
            };

            // Adicionar listeners
            selectUnidade.addEventListener('change', handlerUnidade);
            selectVendedor.addEventListener('change', handlerVendedor);
            
            console.log('‚úÖ Dropdowns inicializados com sucesso usando dados do JSON!');
        }

        // ============================================
        // CLASSE PARA GERENCIAR OS AGENDAMENTOS
        // ============================================
        class AgendamentoManager {
            constructor() {
                this.agendamentoEditando = null;
                this.agendamentos = [];
                this.configurarFormulario();
                this.carregarAgendamentos();
            }

            // Carregar agendamentos do Firebase
            carregarAgendamentos() {
                const agendamentosRef = database.ref('agendamentos');
                
                console.log('Conectando ao Firebase...');
                
                agendamentosRef.on('value', (snapshot) => {
                    const dados = snapshot.val();
                    console.log('Dados recebidos do Firebase:', dados);
                    this.agendamentos = dados ? Object.keys(dados).map(key => ({
                        id: key,
                        ...dados[key]
                    })) : [];
                    console.log('Agendamentos processados:', this.agendamentos);
                    this.renderizarLista();
                }, (error) => {
                    console.error('Erro ao carregar agendamentos:', error);
                    console.error('C√≥digo do erro:', error.code);
                    console.error('Mensagem do erro:', error.message);
                    alert('Erro ao carregar agendamentos: ' + error.message + '\n\nVerifique as regras de seguran√ßa do Firebase.');
                });
            }

            // Adicionar novo agendamento
            adicionarAgendamento(data, nome = '', unidade = '', vendedor = '', perfilVendedor = '', comentarios = '') {
                // Buscar nomes dos valores selecionados
                const unidadeNome = this.obterNomeUnidade(unidade);
                const vendedorNome = this.obterNomeVendedor(vendedor);
                
                const novoAgendamento = {
                    data: data,
                    nome: nome,
                    unidade: unidadeNome || unidade,
                    unidadeId: unidade,
                    vendedor: vendedorNome || vendedor,
                    vendedorId: vendedor,
                    perfilVendedor: perfilVendedor,
                    comentarios: comentarios,
                    status: 'Aguardando',
                    dataCriacao: new Date().toISOString()
                };

                console.log('Tentando adicionar agendamento:', novoAgendamento);

                database.ref('agendamentos').push(novoAgendamento)
                    .then((ref) => {
                        console.log('Agendamento adicionado com sucesso! ID:', ref.key);
                        // O listener do Firebase vai atualizar automaticamente a lista
                    })
                    .catch((error) => {
                        console.error('Erro ao adicionar agendamento:', error);
                        console.error('C√≥digo do erro:', error.code);
                        console.error('Mensagem do erro:', error.message);
                        alert('Erro ao adicionar agendamento: ' + error.message + '\n\nVerifique o console do navegador (F12) para mais detalhes.');
                    });
            }

            // Atualizar status de um agendamento
            atualizarStatus(id, novoStatus) {
                database.ref(`agendamentos/${id}/status`).set(novoStatus)
                    .catch((error) => {
                        console.error('Erro ao atualizar status:', error);
                        alert('Erro ao atualizar status. Tente novamente.');
                    });
            }

            // Atualizar todos os campos de um agendamento
            atualizarAgendamento(id, dados) {
                const updates = {};
                Object.keys(dados).forEach(campo => {
                    updates[`agendamentos/${id}/${campo}`] = dados[campo];
                });

                database.ref().update(updates)
                    .then(() => {
                        this.agendamentoEditando = null;
                    })
                    .catch((error) => {
                        console.error('Erro ao atualizar agendamento:', error);
                        alert('Erro ao atualizar agendamento. Tente novamente.');
                    });
            }

            // Iniciar modo de edi√ß√£o
            iniciarEdicao(id) {
                this.agendamentoEditando = id;
                this.renderizarLista();
            }

            // Cancelar edi√ß√£o
            cancelarEdicao() {
                this.agendamentoEditando = null;
                this.renderizarLista();
            }

            // Salvar edi√ß√£o
            salvarEdicao(id) {
                const nome = document.getElementById(`edit-nome-${id}`).value.trim();
                const unidade = document.getElementById(`edit-unidade-${id}`).value.trim();
                const vendedor = document.getElementById(`edit-vendedor-${id}`).value.trim();
                const perfilVendedor = document.getElementById(`edit-perfilVendedor-${id}`).value.trim();
                const comentarios = document.getElementById(`edit-comentarios-${id}`).value.trim();
                const status = document.getElementById(`status-${id}`).value;

                this.atualizarAgendamento(id, {
                    nome: nome,
                    unidade: unidade,
                    vendedor: vendedor,
                    perfilVendedor: perfilVendedor,
                    comentarios: comentarios,
                    status: status
                });
            }

            // Remover agendamento
            removerAgendamento(id) {
                if (confirm('Tem certeza que deseja remover este agendamento?')) {
                    database.ref(`agendamentos/${id}`).remove()
                        .catch((error) => {
                            console.error('Erro ao remover agendamento:', error);
                            alert('Erro ao remover agendamento. Tente novamente.');
                        });
                }
            }

            // Formatar data para exibi√ß√£o
            formatarData(dataString) {
                const data = new Date(dataString + 'T00:00:00');
                const opcoes = { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric'
                };
                return data.toLocaleDateString('pt-BR', opcoes);
            }

            // Formatar data curta
            formatarDataCurta(dataString) {
                const data = new Date(dataString + 'T00:00:00');
                const opcoes = { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric'
                };
                return data.toLocaleDateString('pt-BR', opcoes);
            }

            // Renderizar lista de agendamentos
            renderizarLista() {
                const container = document.getElementById('eventsList');
                
                if (this.agendamentos.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                            </svg>
                            <p>Nenhum agendamento cadastrado ainda.</p>
                            <p style="margin-top: 10px; font-size: 0.9rem;">Adicione um novo agendamento usando o formul√°rio acima.</p>
                        </div>
                    `;
                    return;
                }

                // Ordenar agendamentos por data (mais recentes primeiro)
                const agendamentosOrdenados = [...this.agendamentos].sort((a, b) => {
                    return new Date(b.data) - new Date(a.data);
                });

                let html = `
                    <table class="events-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Nome</th>
                                <th>Unidade</th>
                                <th>Vendedor da Rota</th>
                                <th>Perfil do Vendedor</th>
                                <th>Coment√°rios</th>
                                <th>Status</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                agendamentosOrdenados.forEach(agendamento => {
                    const dataFormatada = this.formatarDataCurta(agendamento.data);
                    const classeStatus = `status-${agendamento.status.toLowerCase()}`;
                    const emEdicao = this.agendamentoEditando === agendamento.id;
                    
                    if (emEdicao) {
                        // Modo de edi√ß√£o
                        html += `
                            <tr class="editing-row">
                                <td>${dataFormatada}</td>
                                <td>
                                    <input 
                                        type="text" 
                                        class="table-input"
                                        id="edit-nome-${agendamento.id}"
                                        value="${this.escapeHtml(agendamento.nome || '')}" 
                                        placeholder="Nome..."
                                    >
                                </td>
                                <td>
                                    <input 
                                        type="text" 
                                        class="table-input"
                                        id="edit-unidade-${agendamento.id}"
                                        value="${this.escapeHtml(agendamento.unidade || '')}" 
                                        placeholder="Unidade..."
                                    >
                                </td>
                                <td>
                                    <input 
                                        type="text" 
                                        class="table-input"
                                        id="edit-vendedor-${agendamento.id}"
                                        value="${this.escapeHtml(agendamento.vendedor || '')}" 
                                        placeholder="Vendedor..."
                                    >
                                </td>
                                <td>
                                    <input 
                                        type="text" 
                                        class="table-input"
                                        id="edit-perfilVendedor-${agendamento.id}"
                                        value="${this.escapeHtml(agendamento.perfilVendedor || '')}" 
                                        placeholder="Perfil..."
                                        readonly
                                        style="background: #f5f5f5;"
                                    >
                                </td>
                                <td>
                                    <textarea 
                                        class="table-textarea"
                                        id="edit-comentarios-${agendamento.id}"
                                        placeholder="Coment√°rios..."
                                    >${this.escapeHtml(agendamento.comentarios || '')}</textarea>
                                </td>
                                <td>
                                    <select 
                                        class="status-select" 
                                        id="status-${agendamento.id}"
                                        style="font-size: 0.8rem; padding: 4px 6px;"
                                    >
                                        <option value="Aguardando" ${agendamento.status === 'Aguardando' ? 'selected' : ''}>Aguardando</option>
                                        <option value="Conclu√≠do" ${agendamento.status === 'Conclu√≠do' ? 'selected' : ''}>Conclu√≠do</option>
                                        <option value="Cancelado" ${agendamento.status === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
                                    </select>
                                </td>
                                <td>
                                    <div class="table-actions">
                                        <button 
                                            class="btn-save" 
                                            onclick="agendamentoManager.salvarEdicao('${agendamento.id}')"
                                            title="Salvar"
                                            style="padding: 4px 8px; font-size: 0.7rem;"
                                        >
                                            üíæ
                                        </button>
                                        <button 
                                            class="btn-cancel" 
                                            onclick="agendamentoManager.cancelarEdicao()"
                                            title="Cancelar"
                                            style="padding: 4px 8px; font-size: 0.7rem;"
                                        >
                                            ‚úñÔ∏è
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `;
                    } else {
                        // Modo de leitura
                        html += `
                            <tr>
                                <td>${dataFormatada}</td>
                                <td>${this.escapeHtml(agendamento.nome || '-')}</td>
                                <td>${this.escapeHtml(agendamento.unidade || '-')}</td>
                                <td>${this.escapeHtml(agendamento.vendedor || '-')}</td>
                                <td>${this.escapeHtml(agendamento.perfilVendedor || '-')}</td>
                                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${this.escapeHtml(agendamento.comentarios || '')}">
                                    ${this.escapeHtml(agendamento.comentarios || '-')}
                                </td>
                                <td>
                                    <span class="event-status ${classeStatus}">${agendamento.status}</span>
                                </td>
                                <td>
                                    <div class="table-actions">
                                        <select 
                                            class="status-select" 
                                            onchange="agendamentoManager.atualizarStatus('${agendamento.id}', this.value)"
                                            style="font-size: 0.75rem; padding: 4px 6px;"
                                        >
                                            <option value="Aguardando" ${agendamento.status === 'Aguardando' ? 'selected' : ''}>Aguardando</option>
                                            <option value="Conclu√≠do" ${agendamento.status === 'Conclu√≠do' ? 'selected' : ''}>Conclu√≠do</option>
                                            <option value="Cancelado" ${agendamento.status === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
                                        </select>
                                        <button 
                                            class="btn-edit" 
                                            onclick="agendamentoManager.iniciarEdicao('${agendamento.id}')"
                                            title="Editar"
                                            style="padding: 4px 8px; font-size: 0.7rem;"
                                        >
                                            ‚úèÔ∏è
                                        </button>
                                        <button 
                                            class="btn-delete" 
                                            onclick="agendamentoManager.removerAgendamento('${agendamento.id}')"
                                            title="Excluir"
                                            style="padding: 4px 8px; font-size: 0.7rem;"
                                        >
                                            üóëÔ∏è
                                        </button>
                                        <a 
                                            href="${this.gerarLink(agendamento)}"
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            class="btn-link"
                                            title="Abrir link"
                                            style="padding: 4px 8px; font-size: 0.7rem;"
                                        >
                                            üîó
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }
                });

                html += `
                        </tbody>
                    </table>
                `;

                container.innerHTML = html;
            }

            // Obter nome da unidade pelo ID
            obterNomeUnidade(unidadeId) {
                if (!unidadeId) return '';
                const unidade = dadosListaSuspensa.unidades.find(u => u.id === unidadeId);
                return unidade ? unidade.nome : '';
            }

            // Obter nome do vendedor pelo ID
            obterNomeVendedor(vendedorId) {
                if (!vendedorId) return '';
                const vendedor = dadosListaSuspensa.vendedores.find(v => v.id === vendedorId);
                return vendedor ? vendedor.nome : '';
            }

            // Gerar link para o agendamento
            gerarLink(agendamento) {
                // Link para o formul√°rio de Pesquisa de Satisfa√ß√£o do Cliente
                return 'https://forms.gle/jBkZhmU4fKf7r7sU8';
            }

            // Escapar HTML para prevenir XSS
            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Configurar formul√°rio
            configurarFormulario() {
                const form = document.getElementById('agendamentoForm');
                const inputData = document.getElementById('dataVisita');
                
                // Definir data m√≠nima como hoje
                const hoje = new Date().toISOString().split('T')[0];
                inputData.setAttribute('min', hoje);

                form.addEventListener('submit', (e) => {
                    e.preventDefault();
                    
                    const data = inputData.value;
                    const nome = document.getElementById('nome').value.trim();
                    const unidade = document.getElementById('unidade').value.trim();
                    const vendedor = document.getElementById('vendedor').value.trim();
                    const perfilVendedor = document.getElementById('perfilVendedor').value.trim();
                    const comentarios = document.getElementById('comentarios').value.trim();
                    
                    if (!data) {
                        alert('Por favor, preencha o campo obrigat√≥rio (Data).');
                        return;
                    }

                    if (!unidade) {
                        alert('Por favor, selecione a unidade.');
                        return;
                    }

                    if (!vendedor) {
                        alert('Por favor, selecione o vendedor da rota.');
                        return;
                    }

                    this.adicionarAgendamento(data, nome, unidade, vendedor, perfilVendedor, comentarios);
                    
                    // Limpar formul√°rio
                    form.reset();
                    inputData.setAttribute('min', hoje);
                    
                    // Resetar dropdowns
                    const selectUnidade = document.getElementById('unidade');
                    const selectVendedor = document.getElementById('vendedor');
                    const inputPerfil = document.getElementById('perfilVendedor');
                    
                    if (selectUnidade) {
                        selectUnidade.value = '';
                    }
                    if (selectVendedor) {
                        selectVendedor.innerHTML = '<option value="">Primeiro selecione a unidade</option>';
                        selectVendedor.disabled = true;
                    }
                    if (inputPerfil) {
                        inputPerfil.value = '';
                    }
                    
                    // Scroll suave para o novo item
                    setTimeout(() => {
                        window.scrollTo({
                            top: document.querySelector('.list-section').offsetTop - 20,
                            behavior: 'smooth'
                        });
                    }, 100);
                });
            }
        }

        // Inicializar o sistema quando a p√°gina carregar
        let agendamentoManager;
        document.addEventListener('DOMContentLoaded', async () => {
            // Verificar se o database foi inicializado
            if (typeof database === 'undefined' || !database) {
                console.error('Database n√£o foi inicializado!');
                alert('Erro: N√£o foi poss√≠vel conectar ao banco de dados. Verifique o console (F12) para mais detalhes.');
                return;
            }
            
            // Carregar dados das listas suspensas primeiro
            console.log('Carregando dados das listas suspensas...');
            await carregarDadosListaSuspensa();
            
            console.log('Inicializando AgendamentoManager...');
            agendamentoManager = new AgendamentoManager();
        });
    </script>
</body>
</html>

